<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>B1 â€¢ Ø¯Ø±Ø³ Û± â€” Pronomi diretti + Viaggio (Precision)</title>
<style>
:root{color-scheme:dark}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b1222;color:#e5e7eb}
header{position:sticky;top:0;background:#0b1222cc;border-bottom:1px solid #1f2937;backdrop-filter:blur(6px)}
.container{max-width:1100px;margin:0 auto;padding:12px 16px}
.title{font-weight:800;font-size:22px;margin:0}.muted{opacity:.75;font-size:14px}
.card{border:1px solid #1f2937;border-radius:16px;padding:14px;background:#0e162b}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{background:#fff;color:#0b1222;border:0;padding:8px 12px;border-radius:12px;cursor:pointer}
.btn.secondary{background:#d1d5db;color:#111827}
.tabs{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
.tab{border:1px solid #334155;padding:6px 10px;border-radius:10px;cursor:pointer}
.tab.active{background:#1f2937}
.grid{display:grid;gap:12px}
.youtube{aspect-ratio:16/9;width:100%;border-radius:12px;border:1px solid #1f2937;overflow:hidden}
.vocab-pill{display:inline-block;margin:3px;padding:4px 8px;border:1px solid #334155;border-radius:999px;cursor:pointer}
.reading span.token{padding:1px 3px;border-radius:6px;cursor:pointer}
.reading span.token.hit{background:#1e293b;border-bottom:1px dashed #64748b}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;backdrop-filter:blur(3px);background:#0b1222aa;z-index:50}
.modal .box{max-width:640px;width:92%;background:#0e162b;border:1px solid #1f2937;border-radius:16px;padding:16px}
.close{float:left;cursor:pointer;font-weight:700}
.k{font-weight:700;color:#93c5fd}
details{border:1px dashed #334155;border-radius:10px;padding:8px}summary{cursor:pointer}
.settings-btn{position:fixed;bottom:14px;left:14px}
.label{font-size:13px;opacity:.8}
input,textarea{background:#0b1326;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:8px}
</style>
</head>
<body>
<header>
  <div class="container row">
    <div class="title">B1 â€¢ Ø¯Ø±Ø³ Û± â€” Pronomi diretti + Viaggio (Precision)</div>
    <div class="muted">Ø³Ù‡ Ø¬Ù„Ø³Ù‡ + Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡ + ØªØµØ­ÛŒØ­ Ø¯Ù‚ÛŒÙ‚ (Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ†)</div>
  </div>
</header>

<main class="container">
  <div class="tabs">
    <div class="tab active" data-tab="s1">Ø¬Ù„Ø³Ù‡ Û±</div>
    <div class="tab" data-tab="s2">Ø¬Ù„Ø³Ù‡ Û²</div>
    <div class="tab" data-tab="s3">Ø¬Ù„Ø³Ù‡ Û³</div>
  </div>
  <div id="view"></div>
</main>

<button class="btn secondary settings-btn" onclick="openSettings()">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>

<!-- Dictionary modal -->
<div class="modal" id="dictModal">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div class="title" id="dw"></div>
      <div class="close" onclick="hideModal('dictModal')">Ã—</div>
    </div>
    <div>
      <div><span class="k">Ù…Ø¹Ù†ÛŒ (FA):</span> <span id="dfa"></span></div>
      <div><span class="k">ØªØ¹Ø±ÛŒÙ (IT):</span> <span id="dit"></span></div>
      <div><span class="k">Ù…ØªØ±Ø§Ø¯Ùâ€ŒÙ‡Ø§:</span> <span id="dsyn"></span></div>
      <div><span class="k">Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ ÙˆØ§Ú˜Ú¯Ø§Ù†:</span> <span id="dfam"></span></div>
      <div><span class="k">Ù…Ø«Ø§Ù„ Û±:</span> <div id="dex1" class="muted"></div></div>
      <div><span class="k">Ù…Ø«Ø§Ù„ Û²:</span> <div id="dex2" class="muted"></div></div>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal" id="settingsModal">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div class="title">ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØµØ­ÛŒØ­ Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
      <div class="close" onclick="hideModal('settingsModal')">Ã—</div>
    </div>
    <div class="row" style="flex-direction:column;align-items:stretch;">
      <label class="label">OpenAI API Key</label>
      <input id="apiKey" placeholder="sk-..." />
      <label class="label">Model</label>
      <input id="modelName" value="gpt-4o-mini" />
      <button class="btn" onclick="saveSettings()">Ø°Ø®ÛŒØ±Ù‡</button>
      <div class="muted">Ú©Ù„ÛŒØ¯ ÙÙ‚Ø· Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± ØªÙˆ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (localStorage).</div>
    </div>
  </div>
</div>

<script>
// ===== Data (B1 â€“ Lesson 1) =====
const DATA = {
  id: "b1_01",
  title: "B1 â€¢ Ø¯Ø±Ø³ Û± â€” Pronomi diretti + Viaggio",
  grammar: {
    focus: "Uso di lo, la, li, le in contesto viaggio",
    parts: [
      "Posizione dei pronomi diretti: prima del verbo (lo/la/li/le).",
      "Passato prossimo: accordo col participio se il pronome Ã¨ prima (Lâ€™ho vista / Li ho incontrati).",
      "Verbi di viaggio con pronomi: Prenoto la camera â†’ <b>La</b> prenoto; Confermo la prenotazione â†’ <b>La</b> confermo."
    ]
  },
  vocab: [
    V("prenotazione","Ø±Ø²Ø±Ùˆ","atto di prenotare",["riservazione"],["prenotare","prenotato"],"Ho fatto una prenotazione.","La prenotazione Ã¨ a nome Sara."),
    V("itinerario","Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³ÙØ±","percorso pianificato",["percorso"],["itinerante"],"Lâ€™itinerario Ã¨ di tre giorni.","Cambiamo lâ€™itinerario se piove."),
    V("sistemazione","Ù…Ø­Ù„ Ø§Ù‚Ø§Ù…Øª","alloggio temporaneo",["alloggio"],["sistemare"],"Cerco una sistemazione economica.","La sistemazione Ã¨ confortevole."),
    V("albergo","Ù‡ØªÙ„","struttura ricettiva",["hotel"],["albergatore"],"Lâ€™albergo Ã¨ vicino al centro.","Questo albergo ha la colazione inclusa."),
    V("ostello","Ù‡Ø§Ø³ØªÙ„","alloggio condiviso economico",["dormitorio"], [],"In ostello risparmio.","Lâ€™ostello Ã¨ pulito."),
    V("appartamento","Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†","abitazione in affitto",["alloggio"],["appartare"],"Affitto un appartamento.","Lâ€™appartamento Ã¨ luminoso."),
    V("tariffa","ØªØ¹Ø±ÙÙ‡","prezzo di un servizio",["prezzo"], [],"La tariffa per notte Ã¨ alta.","Le tariffe cambiano."),
    V("convenienza","ØµØ±ÙÙ‡ Ø§Ù‚ØªØµØ§Ø¯ÛŒ","vantaggio economico",["vantaggio"],["conveniente"],"Valuto la convenienza.","Non câ€™Ã¨ convenienza."),
    V("prenotazione anticipata","Ø±Ø²Ø±Ùˆ Ø²ÙˆØ¯Ù‡Ù†Ú¯Ø§Ù…","prenotazione prima del tempo",["early booking"], [],"Conviene la prenotazione anticipata.","Con la prenotazione anticipata risparmi."),
    V("caparra","Ø¨ÛŒØ¹Ø§Ù†Ù‡","somma versata in anticipo",["anticipo"], [],"Devo lasciare una caparra.","La caparra non Ã¨ rimborsabile."),
    V("check-in","ØªØ³ÙˆÛŒÙ‡ ÙˆØ±ÙˆØ¯","procedura di arrivo",["registrazione"], [],"Il check-in Ã¨ alle 14.","Facciamo il check-in online."),
    V("check-out","ØªØ³ÙˆÛŒÙ‡ Ø®Ø±ÙˆØ¬","procedura di partenza",["uscita"], [],"Il check-out Ã¨ a mezzogiorno.","Late check-out, per favore."),
    V("documento","Ù…Ø¯Ø±Ú© Ù‡ÙˆÛŒØªÛŒ","carta dâ€™identitÃ /passaporto",["identitÃ "], [],"Mostri un documento.","Ho dimenticato i documenti."),
    V("biglietto","Ø¨Ù„ÛŒØ·","titolo di viaggio",["ticket"],["biglietteria"],"Ho perso il biglietto.","I biglietti sono esauriti."),
    V("ricevuta","Ø±Ø³ÛŒØ¯","prova di pagamento",["scontrino"],["ricevere"],"Mi serve la ricevuta.","La ricevuta Ã¨ digitale."),
    V("rimborso","Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª","restituzione del denaro",["restituzione"],["rimborsare"],"Chiedo il rimborso.","Il rimborso arriva in 5 giorni."),
    V("ritardo","ØªØ§Ø®ÛŒØ±","arrivo oltre orario",["tardanza"],["ritardare"],"Il treno ha ritardo.","Mi scuso per il ritardo."),
    V("coincidenza","Ø§ØªØµØ§Ù„/ØªØ±Ø§Ù†Ø²ÛŒØª","cambio di mezzo",["trasferimento"],["coincidere"],"Perdo la coincidenza.","La coincidenza Ã¨ breve."),
    V("tratta","Ù…Ø³ÛŒØ± (Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„)","segmento di percorso",["percorso"],["trattare"],"Questa tratta Ã¨ lunga.","Cambio tratta."),
    V("capolinea","Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Ù¾Ø§ÛŒØ§Ù†ÛŒ","ultima fermata",["terminale"], [],"Scendiamo al capolinea.","Il capolinea Ã¨ lontano."),
    V("sportello informazioni","Ú¯ÛŒØ´Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª","desk informativo",["sportello"],["sportellista"],"Vai allo sportello informazioni.","Lo sportello chiude alle 18."),
    V("valigia","Ú†Ù…Ø¯Ø§Ù†","bagaglio",["bagaglio"],["valigiato"],"La valigia Ã¨ pesante.","Fai la valigia stasera."),
    V("zaino","Ú©ÙˆÙ„Ù‡","borsa sulle spalle",["sacca"], [],"Porto uno zaino leggero.","Lo zaino Ã¨ comodo."),
    V("trasferimento","ØªØ±Ù†Ø³ÙØ±/Ø§Ù†ØªÙ‚Ø§Ù„","spostamento organizzato",["navetta"],["trasferire"],"Trasferimento dallâ€™aeroporto incluso.","Prenoto un trasferimento."),
    V("navetta","Ø´Ø§ØªÙ„","mezzo di collegamento",["shuttle"], [],"Câ€™Ã¨ una navetta gratuita?","La navetta parte ogni 30 minuti."),
    V("cassaforte","Ú¯Ø§ÙˆØµÙ†Ø¯ÙˆÙ‚","box di sicurezza",["cassetta di sicurezza"], [],"Metti i documenti in cassaforte.","La cassaforte non funziona."),
    V("accoglienza","Ù¾Ø°ÛŒØ±Ø´/Ù…Ù‡Ù…Ø§Ù†â€ŒÙ†ÙˆØ§Ø²ÛŒ","ospitalitÃ ",["ospitalitÃ "],["accogliere"],"Lâ€™accoglienza Ã¨ ottima.","Apprezzo lâ€™accoglienza."),
    V("colazione inclusa","ØµØ¨Ø­Ø§Ù†Ù‡ Ø´Ø§Ù…Ù„","breakfast incluso",["B&B"], [],"La colazione inclusa Ã¨ a buffet.","La colazione non Ã¨ inclusa."),
    V("mezza pensione","Ù†ÛŒÙ…â€ŒÙ¾Ø§Ù†Ø³ÛŒÙˆÙ†","colazione + cena",[], [],"Preferisco la mezza pensione.","La mezza pensione conviene."),
    V("pensione completa","ÙÙˆÙ„â€ŒØ¨Ø±Ø¯","colazione+pranzo+cena",[], [],"La pensione completa Ã¨ costosa.","Offrono pensione completa?"),
    V("disponibile","Ø¯Ø± Ø¯Ø³ØªØ±Ø³","che si puÃ² usare",["libero"],["disponibilitÃ "],"Ãˆ disponibile una doppia?","Non sono disponibile."),
    V("camera doppia","Ø§ØªØ§Ù‚ Ø¯Ùˆ Ù†ÙØ±Ù‡","stanza per due",["doppia"], [],"Una camera doppia, per favore.","La camera doppia ha balcone."),
    V("matrimoniale","Ø¯Ø¨Ù„","letto matrimoniale",[], [],"Preferisco matrimoniale.","La matrimoniale Ã¨ occupata."),
    V("singola","ØªÚ©â€ŒÙ†ÙØ±Ù‡","stanza per una persona",[], [],"Una singola va bene.","La singola Ã¨ piccola."),
    V("vista sul mare","ÙˆÛŒÙˆ Ø¯Ø±ÛŒØ§","affaccio sul mare",[], [],"La voglio con vista sul mare.","Non câ€™Ã¨ vista sul mare."),
    V("prenotare","Ø±Ø²Ø±Ùˆ Ú©Ø±Ø¯Ù†","riservare",["riservare"],["prenotazione"],"Prenoto per due notti.","Hai prenotato lâ€™albergo?"),
    V("confermare","ØªØ£ÛŒÛŒØ¯ Ú©Ø±Ø¯Ù†","rendere definitivo",["convalidare"],["conferma"],"Confermo la prenotazione.","Confermi lâ€™orario?"),
    V("cancellare","Ù„ØºÙˆ Ú©Ø±Ø¯Ù†","annullare",["disdire"],["cancellazione"],"Posso cancellare senza penale?","Hanno cancellato il volo."),
    V("modificare","ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù†","cambiare",["variare"],["modifica"],"Voglio modificare la data.","Facciamo una modifica."),
    V("penale","Ø¬Ø±ÛŒÙ…Ù‡/Ú©Ø§Ø±Ù…Ø²Ø¯ Ù„ØºÙˆ","costo di cancellazione",["multa"], [],"Câ€™Ã¨ una penale?","Qual Ã¨ la penale?"),
    V("reclamo","Ø´Ú©Ø§ÛŒØª","protesta formale",["lamentela"],["reclamare"],"Faccio un reclamo.","Il reclamo Ã¨ stato accettato."),
    V("prenotazione flessibile","Ø±Ø²Ø±Ùˆ Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±","modificabile senza penali",["tariffa flessibile"], [],"Preferisco la prenotazione flessibile.","Non Ã¨ flessibile."),
    V("pagamento","Ù¾Ø±Ø¯Ø§Ø®Øª","atto di pagare",["saldo"],["pagare","pagato"],"Il pagamento Ã¨ online.","Paghi al check-in."),
    V("contanti","Ù†Ù‚Ø¯","denaro in monete/banconote",["cash"], [],"Pago in contanti.","Accettate contanti?"),
    V("carta di credito","Ú©Ø§Ø±Øª Ø§Ø¹ØªØ¨Ø§Ø±ÛŒ","carta per pagare",["bancomat"], [],"Pago con carta di credito.","La carta non funziona.")
  ],
  podcasts: [
    {src:"https://www.youtube.com/watch?v=dY8q_WwmPkU", task:"Ascolta e annota 10 frasi utili per prenotare e chiedere informazioni."},
    {src:"https://www.youtube.com/watch?v=xT4TAP8-IvY", task:"Ripeti frasi con pronomi diretti in contesto viaggio (shadowing Ã—3)."}
  ],
  reading: "Ieri ho preparato un itinerario di tre giorni per visitare una cittÃ  che non conoscevo. Per risparmiare ho fatto una prenotazione anticipata in un albergo vicino al centro storico e ho controllato le tariffe di diverse sistemazioni. Alla fine ho scelto una struttura con colazione inclusa: in questo modo, ogni mattina potevo uscire presto senza perdere tempo. Il primo giorno volevo vedere i monumenti principali, ma câ€™Ã¨ stato un imprevisto: il mio volo ha avuto un ritardo di unâ€™ora e ho perso la coincidenza del treno locale. Allo sportello informazioni mi hanno spiegato la nuova tratta e mi hanno dato una ricevuta per il rimborso. Arrivato a destinazione, ho fatto il check-in e ho lasciato la valigia in camera; poi, per comoditÃ , ho prenotato un trasferimento per il giorno dopo. La sera, ho passeggiato lungo il fiume e ho capito che lâ€™accoglienza delle persone era davvero calorosa. Il secondo giorno ho cambiato lâ€™itinerario per visitare un quartiere meno turistico: a conti fatti Ã¨ stata una buona idea, perchÃ© ho speso poco e ho scoperto ristoranti ottimi. Al capolinea dellâ€™autobus, perÃ², era tutto affollato e ho dovuto aspettare a lungo. Infine, il terzo giorno, ho deciso di restare ancora un poâ€™ e di organizzare il check-out nel pomeriggio. Ho confermato la prenotazione flessibile e mi sono assicurato che i documenti fossero in cassaforte. Ãˆ stato un viaggio semplice, ma molto istruttivo: ho imparato a gestire gli imprevisti e a valutare la convenienza prima di scegliere.",
  writing: "ÛŒÚ© Ø±ÙˆØ§ÛŒØª Û±Û²Û° Ú©Ù„Ù…Ù‡â€ŒØ§ÛŒ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ø³ÙØ±Øª Ø¨Ù†ÙˆÛŒØ³ Ùˆ Ø­Ø¯Ø§Ù‚Ù„ Û¸ ÙˆØ§Ú˜Ù‡ Ø§Ø² Ø§ÛŒÙ† Ø¯Ø±Ø³ Ø±Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.",
  quizzes: {
    s1: [
      {type:"cloze", q:"___ confermo per domani. (prenotazione) â†’ ___ confermo.", a:["La","la"]},
      {type:"cloze", q:"Hai i documenti? SÃ¬, ___ ho messi in cassaforte.", a:["li"]},
      {type:"choice",q:"Qual Ã¨ piÃ¹ naturale?",options:["Ho visto la camera.","Lâ€™ho vista."],a:0},
      {type:"cloze", q:"Ho perso la ___ e chiedo il ___.", a:["coincidenza","rimborso"]},
      {type:"choice",q:"Se il treno ha ritardo, vado alloâ€¦",options:["capolinea","sportello informazioni"],a:1}
    ],
    s2: [
      {type:"cloze", q:"Serve una camera ___ con ___ sul mare.", a:["doppia","vista"]},
      {type:"choice",q:"Cosâ€™Ã¨ un costo di cancellazione?",options:["caparra","penale"],a:1},
      {type:"cloze", q:"Preferisco la prenotazione ___: se cambia il piano, ___ modifico.", a:["flessibile","la"]}
    ],
    final: [
      {type:"cloze", q:"___ facciamo il check-__, poi lasciamo la ___ in camera.", a:["Prima","in","valigia"]},
      {type:"choice",q:"Accordo corretto col participio:",options:["Lâ€™ho visto la ricevuta.","Lâ€™ho vista."],a:1},
      {type:"choice",q:"Che significa â€˜shuttleâ€™?",options:["navetta","tratta"],a:0}
    ]
  }
};

// ===== Helpers =====
function V(w,fa,it,syn=[],fam=[],ex1="",ex2=""){return {w,fa,it,syn,fam,ex1,ex2}}
function qs(s,e=document){return e.querySelector(s)}
function el(t,a={},k=[]){const e=document.createElement(t);for(const [x,v] of Object.entries(a)){if(x==='class')e.className=v;else if(x==='html')e.innerHTML=v;else e.setAttribute(x,v)}k.forEach(i=>e.appendChild(typeof i==='string'?document.createTextNode(i):i));return e}
function showModal(id){qs('#'+id).style.display='flex'}
function hideModal(id){qs('#'+id).style.display='none'}
document.addEventListener('keydown',ev=>{if(ev.key==='Escape')document.querySelectorAll('.modal').forEach(m=>m.style.display='none')})

// Settings
function openSettings(){const k=localStorage.getItem('openai_key')||'';const m=localStorage.getItem('openai_model')||'gpt-4o-mini';qs('#apiKey').value=k;qs('#modelName').value=m;showModal('settingsModal')}
function saveSettings(){localStorage.setItem('openai_key',qs('#apiKey').value.trim());localStorage.setItem('openai_model',qs('#modelName').value.trim());hideModal('settingsModal')}

// Dictionary
let DICT={}
const MULTI = new Set(["sportello informazioni","prenotazione anticipata","colazione inclusa","mezza pensione","pensione completa","camera doppia","vista sul mare","check-in","check-out","carta di credito"]);
function buildDict(){DICT={};(DATA.vocab||[]).forEach(v=> DICT[v.w.toLowerCase()] = v)}
function showDict(key){
  const v=DICT[key]; const id='dictModal';
  if(!v){qs('#dw').textContent=key;qs('#dfa').textContent='â€”';qs('#dit').textContent='â€”';qs('#dsyn').textContent='â€”';qs('#dfam').textContent='â€”';qs('#dex1').textContent='â€”';qs('#dex2').textContent='â€”'}
  else{qs('#dw').textContent=v.w;qs('#dfa').textContent=v.fa||'â€”';qs('#dit').textContent=v.it||'â€”';qs('#dsyn').textContent=(v.syn||[]).join(', ')||'â€”';qs('#dfam').textContent=(v.fam||[]).join(', ')||'â€”';qs('#dex1').textContent=v.ex1||'â€”';qs('#dex2').textContent=v.ex2||'â€”'}
  showModal(id);
}

// Reading tokenizer (multi-word aware)
function tokenizeReading(text){
  const wrap = el('div',{class:'reading'});
  let replaced = text;
  MULTI.forEach(mw=>{
    const re = new RegExp(mw.replace(/[-/\\^$*+?.()|[\\]{}]/g,'\\$&'),'gi');
    replaced = replaced.replace(re, m=>`[[[MW:${m}]]]`);
  });
  const parts = replaced.split(/(\\s+|[,.!?;:()\\[\\]])/);
  parts.forEach(tok=>{
    if(!tok)return;
    if(tok.startsWith('[[[MW:')){ const word=tok.slice(6,-3); const key=word.toLowerCase(); const s=el('span',{class:'token hit'},[word]); s.onclick=()=>showDict(key); wrap.appendChild(s); return; }
    const clean = tok.replace(/^[^\\p{L}\\p{N}â€™']+|[^\\p{L}\\p{N}â€™']+$/gu,'');
    const key = clean.toLowerCase();
    if(DICT[key]){ const s=el('span',{class:'token hit'},[tok]); s.onclick=()=>showDict(key); wrap.appendChild(s); }
    else wrap.appendChild(document.createTextNode(tok));
  });
  return wrap;
}

// Quizzes
function quizBox(arr){
  const wrap = el('div',{class:'grid'});
  arr.forEach((q,i)=>{
    const box = el('div',{class:'card'},[]);
    box.appendChild(el('div',{class:'muted'},['Ø³ÙˆØ§Ù„ ',String(i+1)]));
    box.appendChild(el('p',{},[q.q]));
    if(q.type==='cloze'){
      const inputs=q.a.map(()=>el('input',{type:'text',style:'margin:2px'}));
      const check=el('button',{class:'btn secondary'},['ØªØµØ­ÛŒØ­']);
      const res=el('div',{class:'muted'});
      check.onclick=()=>{const norm=s=>s.replace(/â€™/g,"'").toLowerCase().trim();const user=inputs.map(i=>norm(i.value)).join('|');const correct=q.a.map(norm).join('|');res.textContent=(user===correct)?'Ø¯Ø±Ø³Øª':'ØºÙ„Ø· â€” '+q.a.join(' | ')};
      inputs.forEach(i=>box.appendChild(i)); box.appendChild(el('div',{style:'height:6px'})); box.appendChild(check); box.appendChild(res);
    }else if(q.type==='choice'){
      const group='g'+Math.random(); const opts=q.options.map((opt,ix)=>{const lab=el('label',{class:'row'},[]); const r=el('input',{type:'radio',name:group,value:String(ix)}); lab.appendChild(r); lab.appendChild(el('span',{},[opt])); return lab;});
      const check=el('button',{class:'btn secondary'},['ØªØµØ­ÛŒØ­']); const res=el('div',{class:'muted'});
      check.onclick=()=>{let chosen=null; opts.forEach(o=>{const inp=o.querySelector('input'); if(inp.checked) chosen=inp.value;}); res.textContent=(String(chosen)===String(q.a))?'Ø¯Ø±Ø³Øª':'ØºÙ„Ø· â€” '+q.options[q.a];};
      opts.forEach(o=>box.appendChild(o)); box.appendChild(check); box.appendChild(res);
    }
    wrap.appendChild(box);
  });
  return wrap;
}

// Writing offline grader
function gradeWritingOffline(text){
  const out={};
  const t=(text||'').normalize('NFC').replace(/\\s+/g,' ').trim();
  const words=t? t.split(/\\s+/):[];
  const lower=t.toLowerCase();
  out.pronoun_usage=/(\\blo\\b|\\bla\\b|\\bli\\b|\\ble\\b|lâ€™|l')\\s+(ho|hai|ha|abbiamo|avete|hanno)\\s+\\w+/i.test(lower);
  const targets=Object.keys(DICT); let hit=0; targets.forEach(k=>{ if(lower.includes(k)) hit++; });
  out.vocab_hits=hit; out.vocab_total=Math.min(45,targets.length); out.word_count=words.length;
  const lenScore=Math.min(1,out.word_count/120), vocabScore=Math.min(1,out.vocab_hits/8), pronScore=out.pronoun_usage?1:0;
  out.score=Math.round((0.4*lenScore+0.4*vocabScore+0.2*pronScore)*100); return out;
}

// Online grading (optional)
async function gradeOnline(text,type='writing'){
  const key=localStorage.getItem('openai_key'); const model=localStorage.getItem('openai_model')||'gpt-4o-mini';
  if(!key) throw new Error('API key Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');
  const rubric = type==='writing'
    ? "Correggi il testo (italiano B1). Evidenzia: 1) errori grammaticali (con spiegazione breve in persiano), 2) suggerimenti lessicali usando il vocabolario di viaggio (lista allegata), 3) riscrittura corretta. JSON: errors[], suggestions[], rewrite."
    : "Valuta la trascrizione parlata (italiano B1). Indica errori frequenti, suggerisci 5 frasi migliori e dai un voto 0-100. JSON: errors[], suggestions[], score.";
  const vocabList = Object.keys(DICT).join(', ');
  const payload = {model, messages:[
    {role:'system',content:'Sei un insegnante di italiano B1/B2 che restituisce output in JSON.'},
    {role:'user',content:`Rubrica: ${rubric}\nVocabolario target: ${vocabList}\nTESTO:\n`+text}
  ], temperature:0.2};
  const res = await fetch('https://api.openai.com/v1/chat/completions',{
    method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+key}, body:JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø§Ø³ Ø¨Ø§ API');
  const data = await res.json(); return (data.choices?.[0]?.message?.content)||"";
}

// Speaking box
function speakingBox(){
  const box=el('div',{class:'card'},[]);
  box.appendChild(el('h3',{},['Speaking ØªØ¹Ø§Ù…Ù„ÛŒ (Ø¢ÙÙ„Ø§ÛŒÙ†)']));
  box.appendChild(el('div',{class:'muted'},['Ø±ÙˆÛŒ Start Ø¨Ø²Ù† Ùˆ Û¶Û° Ø«Ø§Ù†ÛŒÙ‡ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø±Ø²Ø±Ùˆ Ø§ØªØ§Ù‚ ØµØ­Ø¨Øª Ú©Ù†.']));
  const out=el('textarea',{rows:'6',placeholder:'Transcript...'},[]), res=el('div',{class:'muted'},[]);
  const start=el('button',{class:'btn'},['Start']), stop=el('button',{class:'btn secondary'},['Stop']);
  let rec=null;
  if('webkitSpeechRecognition' in window){const R=new webkitSpeechRecognition();R.lang='it-IT';R.interimResults=true;R.onresult=e=>{let s='';for(let i=0;i<e.results.length;i++) s+=e.results[i][0].transcript+' '; out.value=s.trim();}; rec=R;}
  else res.textContent='Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ø¶Ø¨Ø· Ú¯ÙØªØ§Ø± Ø¯Ø§Ø®Ù„ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯Ø› Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ ØªØ§ÛŒÙ¾ Ú©Ù†.';
  start.onclick=()=>{if(rec)rec.start()}; stop.onclick=()=>{if(rec)rec.stop()};
  const off=el('button',{class:'btn secondary'},['Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†']);
  off.onclick=()=>{const g=gradeWritingOffline(out.value||''); res.textContent='Ø§Ù…ØªÛŒØ§Ø²: '+g.score+'/100 â€” ÙˆØ§Ú˜Ú¯Ø§Ù†: '+g.vocab_hits+' â€” Ø·ÙˆÙ„: '+g.word_count+' â€” Ø¶Ù…ÛŒØ± Ù…Ø³ØªÙ‚ÛŒÙ…: '+(g.pronoun_usage?'âœ“':'âœ—');};
  const on=el('button',{class:'btn'},['Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†']);
  on.onclick=async()=>{try{res.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†...'; const ans=await gradeOnline(out.value||'', 'speaking'); res.textContent=ans;}catch(e){res.textContent='Ø®Ø·Ø§: '+e.message;}};
  box.appendChild(el('div',{class:'row'},[start,stop,off,on])); box.appendChild(out); box.appendChild(res); return box;
}

// Lesson notes
function lessonNote(t,blocks){const card=el('div',{class:'card'},[]);card.appendChild(el('h3',{},[t]));blocks.forEach(b=>card.appendChild(el('div',{class:'muted',html:b})));return card}

// Vocab pills, YouTube
function vocabPills(sub){const box=el('div',{},[]);sub.forEach(w=>{const p=el('span',{class:'vocab-pill'},[w.w]); p.onclick=()=>showDict(w.w.toLowerCase()); box.appendChild(p)});return box}
function youtubeEmbed(u){const src=u.replace('watch?v=','embed/').split('&')[0]; return el('iframe',{class:'youtube',src,title:'YouTube',allow:'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share',allowfullscreen:'true'})}

// Sessions
function renderS1(c){
  c.appendChild(lessonNote('ğŸ“š Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡ â€” Pronomi diretti (Ø¨Ø®Ø´ Û±â€“Û²)',[
    'Ú©Ø§Ø±Ø¨Ø±Ø¯: Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÙØ¹ÙˆÙ„ Ù…Ø³ØªÙ‚ÛŒÙ…. <b>lo, la, li, le</b> Ù¾ÛŒØ´ Ø§Ø² ÙØ¹Ù„.',
    'Ù†Ù…ÙˆÙ†Ù‡: Vedo Marco â†’ <b>Lo</b> vedo. | Mangio la pizza â†’ <b>La</b> mangio.',
    'Passato prossimo: <i>Lâ€™ho vista</i>, <i>Li ho incontrati</i>.'
  ]));
  c.appendChild(lessonNote('ğŸ“š Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡ ÙˆØ§Ú˜Ú¯Ø§Ù† â€” Ø³ÙØ± (Ù‡ØªÙ„/Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„)',[
    'Ø¨Ø³ØªÙ‡ A: prenotazione, itinerario, sistemazione, albergo, ostello, appartamento, tariffa, convenienza, <b>prenotazione anticipata</b>, caparra, <b>check-in</b>, <b>check-out</b>, documento, biglietto, ricevuta, rimborso, ritardo, coincidenza, tratta, capolinea.'
  ]));
  const voc=el('div',{class:'card'},[]); voc.appendChild(el('h3',{},['ÙˆØ§Ú˜Ú¯Ø§Ù† (Ø¨Ø³ØªÙ‡ A)'])); voc.appendChild(vocabPills(DATA.vocab.slice(0,20))); c.appendChild(voc);
  const p1=el('div',{class:'card'},[]); p1.appendChild(el('h3',{},['Podcast 1'])); p1.appendChild(el('div',{class:'muted'},[DATA.podcasts[0].task])); p1.appendChild(youtubeEmbed(DATA.podcasts[0].src)); c.appendChild(p1);
  const q1=el('div',{class:'card'},[]); q1.appendChild(el('h3',{},['ØªÙ…Ø±ÛŒÙ† Ú¯Ø±Ø§Ù…Ø±/ÙˆØ§Ú˜Ú¯Ø§Ù†'])); q1.appendChild(quizBox(DATA.quizzes.s1)); c.appendChild(q1);
}
function renderS2(c){
  c.appendChild(lessonNote('ğŸ“š Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡ â€” Pronomi diretti (Ø¨Ø®Ø´ Û³: Ú©Ø§Ø±Ø¨Ø±Ø¯Ù‡Ø§ÛŒ Ø³ÙØ±)',[
    'Prenoto una camera â†’ <b>La</b> prenoto. | Confermo la prenotazione â†’ <b>La</b> confermo.',
    'Ù†Ú©ØªÙ‡: Ø¶Ù…ÛŒØ± Ùˆ Ø§Ø³Ù… Ø±Ø§ Ø¨Ø§ Ù‡Ù… ØªÚ©Ø±Ø§Ø± Ù†Ú©Ù†.'
  ]));
  c.appendChild(lessonNote('ğŸ“š Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡ ÙˆØ§Ú˜Ú¯Ø§Ù† â€” Ø§Ù…Ú©Ø§Ù†Ø§Øª Ùˆ Ø±Ø²Ø±Ùˆ',[
    'Ø¨Ø³ØªÙ‡ B: sportello informazioni, valigia, zaino, trasferimento, navetta, cassaforte, accoglienza, <b>colazione inclusa</b>, mezza pensione, pensione completa, disponibile, camera doppia, matrimoniale, singola, <b>vista sul mare</b>.'
  ]));
  const voc=el('div',{class:'card'},[]); voc.appendChild(el('h3',{},['ÙˆØ§Ú˜Ú¯Ø§Ù† (Ø¨Ø³ØªÙ‡ B)'])); voc.appendChild(vocabPills(DATA.vocab.slice(20,35))); c.appendChild(voc);
  const p2=el('div',{class:'card'},[]); p2.appendChild(el('h3',{},['Podcast 2'])); p2.appendChild(el('div',{class:'muted'},[DATA.podcasts[1].task])); p2.appendChild(youtubeEmbed(DATA.podcasts[1].src));
  const det=el('details',{},[]); det.appendChild(el('summary',{},['Ú†Ø·ÙˆØ± Listening Ú©Ù†ÛŒÙ…ØŸ'])); det.appendChild(el('ol',{},[el('li',{},['ÛŒÚ© Ø¨Ø§Ø± Ø¨Ø§ Ø²ÛŒØ±Ù†ÙˆÛŒØ³ØŒ ÛŒÚ© Ø¨Ø§Ø± Ø¨Ø¯ÙˆÙ†.']),el('li',{},['Ûµ Ø¹Ø¨Ø§Ø±Øª Ø±Ø§ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ú©Ù† Ùˆ ØªÙ‚Ù„ÛŒØ¯ Ú©Ù†.']),el('li',{},['ÛŒÚ© Ù¾Ø§Ø³Ø® Û¶Û° Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ Ø¨Ø³Ø§Ø².'])])); p2.appendChild(det); c.appendChild(p2);
  c.appendChild(speakingBox());
  const q2=el('div',{class:'card'},[]); q2.appendChild(el('h3',{},['ØªÙ…Ø±ÛŒÙ† ØªÚ©Ù…ÛŒÙ„ÛŒ'])); q2.appendChild(quizBox(DATA.quizzes.s2)); c.appendChild(q2);
}
function renderS3(c){
  c.appendChild(lessonNote('ğŸ“š Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡ ÙˆØ§Ú˜Ú¯Ø§Ù† â€” Ø§ØµØ·Ù„Ø§Ø­Ø§Øª Ùˆ Ø§ÙØ¹Ø§Ù„ Ù…Ø±Ú©Ø¨',[
    'Ø¨Ø³ØªÙ‡ C: prenotare, confermare, cancellare, modificare, penale, reclamo, <b>prenotazione flessibile</b>, pagamento, contanti, <b>carta di credito</b>.'
  ]));
  const r=el('div',{class:'card'},[]); r.appendChild(el('h3',{},['Reading (Ù…ØªÙ† Ø¨Ù„Ù†Ø¯) â€” Ø±ÙˆÛŒ ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ø¯Ù Ú©Ù„ÛŒÚ© Ú©Ù†'])); r.appendChild(tokenizeReading(DATA.reading));
  const det=el('details',{},[]); det.appendChild(el('summary',{},['Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Reading'])); det.appendChild(el('ol',{},[el('li',{},['Ø§ÛŒØ¯Ù‡â€ŒÛŒ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø¯Ø± ÛŒÚ© Ø¬Ù…Ù„Ù‡ Ø¨Ù†ÙˆÛŒØ³.']),el('li',{},['Û³ Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ù„ÛŒØ¯ÛŒ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†.']),el('li',{},['ÛŒÚ© Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ø±Ø§ Ø¨Ø§ ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ù†.'])])); r.appendChild(det); c.appendChild(r);
  const w=el('div',{class:'card'},[]); w.appendChild(el('h3',{},['Writing (Û±Û²Û° Ú©Ù„Ù…Ù‡) â€” ØªØµØ­ÛŒØ­ Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ†'])); const ta=el('textarea',{rows:'8',placeholder:'Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³...'},[]);
  const status=el('div',{class:'muted'},['â€”']); const wc=el('div',{class:'muted'},['0 Ú©Ù„Ù…Ù‡']); ta.addEventListener('input',()=>{const n=(ta.value.trim().match(/\\S+/g)||[]).length; wc.textContent=n+' Ú©Ù„Ù…Ù‡'});
  const off=el('button',{class:'btn secondary'},['ØªØµØ­ÛŒØ­ Ø¢ÙÙ„Ø§ÛŒÙ†']); off.onclick=()=>{const g=gradeWritingOffline(ta.value||''); status.textContent=`Ø§Ù…ØªÛŒØ§Ø²: ${g.score}/100 â€¢ ÙˆØ§Ú˜Ú¯Ø§Ù†: ${g.vocab_hits}/${g.vocab_total} â€¢ Ø·ÙˆÙ„: ${g.word_count} â€¢ Ø¶Ù…ÛŒØ± Ù…Ø³ØªÙ‚ÛŒÙ…: ${g.pronoun_usage?'âœ“':'âœ—'}`};
  const on=el('button',{class:'btn'},['ØªØµØ­ÛŒØ­ Ø¢Ù†Ù„Ø§ÛŒÙ†']); on.onclick=async()=>{try{status.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ ØªØµØ­ÛŒØ­ Ø¢Ù†Ù„Ø§ÛŒÙ†...'; const ans=await gradeOnline(ta.value||'', 'writing'); status.textContent=ans;}catch(e){status.textContent='Ø®Ø·Ø§: '+e.message;}}
  const dl=el('button',{class:'btn secondary'},['Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…ØªÙ†']); dl.onclick=()=>{const blob=new Blob([ta.value],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='B1_L1_writing.txt'; a.click();}
  w.appendChild(el('div',{class:'row'},[off,on,dl])); w.appendChild(ta); w.appendChild(wc); w.appendChild(status); c.appendChild(w);
  const qf=el('div',{class:'card'},[]); qf.appendChild(el('h3',{},['Quiz Ù†Ù‡Ø§ÛŒÛŒ'])); qf.appendChild(quizBox(DATA.quizzes.final)); c.appendChild(qf);
}

// Router
function render(tab){const v=qs('#view'); v.innerHTML=''; if(tab==='s1')renderS1(v); if(tab==='s2')renderS2(v); if(tab==='s3')renderS3(v);}
function initTabs(){const tabs=document.querySelectorAll('.tab'); tabs.forEach(tb=>tb.onclick=()=>{tabs.forEach(t=>t.classList.remove('active')); tb.classList.add('active'); render(tb.dataset.tab);}); render('s1');}
buildDict(); initTabs();
</script>
</body>
</html>
